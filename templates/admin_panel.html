{% extends "layout.html" %}

{% block content %}
  <h2>Управление категориями</h2>
  <input type="text" id="category-name" placeholder="Введите имя категории">
  <button onclick="addCategory()">Добавить категорию</button>

  <div id="category-list">
    <!-- Категории будут загружены сюда -->
  </div>

  <h2>Управление товарами</h2>
  <input type="text" id="product-name" placeholder="Введите имя товара">
  <select id="product-category-id">
    <!-- Сюда добавлять список категорий для выбора -->
  </select>
  <button onclick="addProduct()">Добавить продукт</button>

  <div id="product-list">
    <!-- Продукты будут загружены сюда -->
  </div>

  <script>
    // Загрузка категорий и товаров при загрузке страницы
    document.addEventListener("DOMContentLoaded", function() {
      loadCategories();
      loadProducts();
    });

    // Функция для загрузки категорий
    function loadCategories() {
      fetch("/api/categories")  // Эндпоинт для получения списка категорий
        .then(response => response.json())
        .then(data => {
          const categorySelect = document.getElementById("product-category-id");
          const categoryList = document.getElementById("category-list");

          // Очистить предыдущий список
          categorySelect.innerHTML = "";
          categoryList.innerHTML = "";

          // Добавить категории в список
          data.categories.forEach(category => {
            const categoryOption = document.createElement("option");
            categoryOption.value = category.id;
            categoryOption.textContent = category.name;
            categorySelect.appendChild(categoryOption);

            const categoryDiv = document.createElement("div");
            categoryDiv.textContent = category.name;
            categoryList.appendChild(categoryDiv);
          });
        })
        .catch(error => {
          console.error("Ошибка загрузки категорий:", error);
        });
    }

    // Функция для загрузки продуктов
    function loadProducts() {
      fetch("/api/products")  // Эндпоинт для получения списка продуктов
        .then(response => response.json())
        .then(data => {
          const productList = document.getElementById("product-list");
          
          // Очистить предыдущий список продуктов
          productList.innerHTML = "";

          // Добавить продукты в список
          data.products.forEach(product => {
            const productDiv = document.createElement("div");
            productDiv.textContent = `${product.name} (${product.category_name})`;
            productList.appendChild(productDiv);
          });
        })
        .catch(error => {
          console.error("Ошибка загрузки продуктов:", error);
        });
    }

    // Функция для добавления категории
    function addCategory() {
      const categoryName = document.getElementById("category-name").value;

      if (categoryName) {
        fetch("/api/add_category", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ name: categoryName })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert("Категория добавлена!");
            loadCategories(); // Перезагружаем категории
          } else {
            alert(data.error || "Ошибка при добавлении категории");
          }
        })
        .catch(error => {
          console.error("Ошибка добавления категории:", error);
          alert("Произошла ошибка при добавлении категории.");
        });
      } else {
        alert("Введите имя категории.");
      }
    }

    // Функция для добавления продукта
    function addProduct() {
      const productName = document.getElementById("product-name").value;
      const productCategoryId = document.getElementById("product-category-id").value;

      if (productName && productCategoryId) {
        fetch("/api/add_product", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ name: productName, category_id: productCategoryId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert("Продукт добавлен!");
            loadProducts(); // Перезагружаем продукты
          } else {
            alert(data.error || "Ошибка при добавлении продукта");
          }
        })
        .catch(error => {
          console.error("Ошибка добавления продукта:", error);
          alert("Произошла ошибка при добавлении продукта.");
        });
      } else {
        alert("Заполните все поля.");
      }
    }
  </script>
{% endblock %}
